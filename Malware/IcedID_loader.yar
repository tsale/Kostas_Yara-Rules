/*
	This rule detects some variants of IcedID loader related to reply chain attacks phishing campaign starting July 20th. The campaign included various zip file attachments 
  and links that lead to zip file attachments. The zip file attachments contained a macro embeded word document.
	
*/

import "pe"
rule IcedID_loader:  {
   meta:
      description = "Detects icedid loader - file main.theme"
      author = "Kostas Tsialemis - @KostasTsale"
      date = "2020-07-31"
      hash1 = "910bc69ded48abf027c4b5840ca34e78bf924d5307331ca3a5b5e62cf5e1cacd"
   strings:
      $a1 = "through.dll" fullword wide
      $a2 = "https://requiregreen.com" fullword wide
      $a3 = "c:\\iron\\color\\Fall\\Mix\\Hold\\Crop\\next\\fun\\through.pdb" fullword ascii	  
      $a4 = "AppPolicyGetProcessTerminationMethod" fullword ascii
      $a5 = "(7 - trail_bytes))" fullword wide
      $a6 = "mb_buf_used + bytes_to_add < mb_buf_size" fullword wide
      $a7 = "1 < mb_len && mb_buf_used < mb_len" fullword wide
      $a8 = "retval != __crt_mbstring::INCOMPLETE" fullword wide
   condition:
      uint16(0) == 0x5a4d and filesize < 450KB and filesize > 200KB and
      (pe.exports("Dictionarywave") and pe.exports("Yardcharge")  and any of them)
}
